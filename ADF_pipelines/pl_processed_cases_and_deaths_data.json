{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"factoryName":{"type":"string","metadata":"Data Factory name"},"ls_adls_covidreportingdl":{"type":"string"}},"variables":{"factoryId":"[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"},"resources":[{"name":"[concat(parameters('factoryName'), '/pl_processed_cases_and_deaths_data')]","type":"Microsoft.DataFactory/factories/pipelines","apiVersion":"2018-06-01","properties":{"activities":[{"name":"df_transform_cases_deaths","type":"ExecuteDataFlow","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"dataflow":{"referenceName":"df_transform_cases_deaths","type":"DataFlowReference","parameters":{},"datasetParameters":{"CasesAndDeathsSource":{},"CountryLookup":{},"CasesAndDeathsSink":{}}},"staging":{},"compute":{"coreCount":8,"computeType":"General"},"traceLevel":"Fine"}}],"policy":{"elapsedTimeMetric":{},"cancelAfter":{}},"folder":{"name":"Process"},"annotations":[],"lastPublishTime":"2023-06-24T09:04:41Z"},"dependsOn":["[concat(variables('factoryId'), '/dataflows/df_transform_cases_deaths')]"]},{"name":"[concat(parameters('factoryName'), '/df_transform_cases_deaths')]","type":"Microsoft.DataFactory/factories/dataflows","apiVersion":"2018-06-01","properties":{"type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"ds_raw_cases_and_deaths","type":"DatasetReference"},"name":"CasesAndDeathsSource"},{"dataset":{"referenceName":"ds_country_lookup","type":"DatasetReference"},"name":"CountryLookup"}],"sinks":[{"dataset":{"referenceName":"ds_processed_cases_and_deaths","type":"DatasetReference"},"name":"CasesAndDeathsSink"}],"transformations":[{"name":"FilterEuropeOnly"},{"name":"SelectOnlyRequiredFields"},{"name":"PivotCounts"},{"name":"LookupCountry"},{"name":"SelectForSink"}],"scriptLines":["source(output(","          country as string,","          country_code as string,","          continent as string,","          population as integer,","          indicator as string,","          daily_count as integer,","          date as date,","          rate_14_day as double,","          source as string","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> CasesAndDeathsSource","source(output(","          country as string,","          country_code_2_digit as string,","          country_code_3_digit as string,","          continent as string,","          population as integer","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> CountryLookup","CasesAndDeathsSource filter(continent == 'Europe' && not(isNull(country_code))) ~> FilterEuropeOnly","FilterEuropeOnly select(mapColumn(","          country,","          country_code,","          population,","          indicator,","          daily_count,","          source,","          each(match(name=='date'),","               'reported_'+'date' = $$)","     ),","     skipDuplicateMapInputs: false,","     skipDuplicateMapOutputs: false) ~> SelectOnlyRequiredFields","SelectOnlyRequiredFields pivot(groupBy(country,","          country_code,","          population,","          source,","          reported_date),","     pivotBy(indicator, ['confirmed cases', 'deaths']),","     count = sum(daily_count),","     columnNaming: '$V_$N',","     lateral: true) ~> PivotCounts","PivotCounts, CountryLookup lookup(PivotCounts@country == CountryLookup@country,","     multiple: false,","     pickup: 'any',","     broadcast: 'auto')~> LookupCountry","LookupCountry select(mapColumn(","          country = PivotCounts@country,","          country_code_2_digit,","          country_code_3_digit,","          population = PivotCounts@population,","          cases_count = {confirmed cases_count},","          deaths_count,","          reported_date,","          source","     ),","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> SelectForSink","SelectForSink sink(allowSchemaDrift: true,","     validateSchema: false,","     partitionFileNames:['cases_and_deaths.csv'],","     truncate: true,","     umask: 0022,","     preCommands: [],","     postCommands: [],","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true,","     partitionBy('hash', 1)) ~> CasesAndDeathsSink"]}},"dependsOn":["[concat(variables('factoryId'), '/datasets/ds_raw_cases_and_deaths')]","[concat(variables('factoryId'), '/datasets/ds_country_lookup')]","[concat(variables('factoryId'), '/datasets/ds_processed_cases_and_deaths')]"]},{"name":"[concat(parameters('factoryName'), '/ds_raw_cases_and_deaths')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_adls_covidreportingdl')]","type":"LinkedServiceReference"},"folder":{"name":"raw"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobFSLocation","fileName":"cases_deaths.csv","folderPath":"ecdc/cases_deaths","fileSystem":"raw"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"country","type":"String"},{"name":"country_code","type":"String"},{"name":"continent","type":"String"},{"name":"population","type":"String"},{"name":"indicator","type":"String"},{"name":"daily_count","type":"String"},{"name":"date","type":"String"},{"name":"rate_14_day","type":"String"},{"name":"source","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_country_lookup')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_adls_covidreportingdl')]","type":"LinkedServiceReference"},"folder":{"name":"lookup"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobFSLocation","fileName":"country-lookup.csv","folderPath":"dim_country","fileSystem":"lookup"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"country","type":"String"},{"name":"country_code_2_digit","type":"String"},{"name":"country_code_3_digit","type":"String"},{"name":"continent","type":"String"},{"name":"population","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_processed_cases_and_deaths')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_adls_covidreportingdl')]","type":"LinkedServiceReference"},"folder":{"name":"processed"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobFSLocation","folderPath":"ecdc/cases_deaths","fileSystem":"processed"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[]},"dependsOn":[]}]}